name: CI

on:
  push:
    branches:
      - master
  schedule:
    - cron: "22 21 * * 1-5"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    - name: Configure git remote
      run: git config --add remote.origin.fetch '+refs/heads/*:refs/remotes/origin/*'
    - name: Fetch gh-pages branch
      run: git fetch origin gh-pages
    - name: Checkout gh-pages branch
      run: git checkout gh-pages
    - name: Copy over generate.sh
      run: git checkout master -- generate.sh
    - name: Run generate.sh and cleanup
      run: |
        ./generate.sh
        rm generate.sh
    - name: Generate commit message from RIR statistics
      id: commit_message
      run: |
        # Extract serial (date) from each RIR statistics file header (skip comment lines starting with #)
        APNIC_SERIAL=$(grep -v '^#' delegated-apnic-latest.txt 2>/dev/null | head -1 | cut -d'|' -f3 || echo "N/A")
        ARIN_SERIAL=$(grep -v '^#' delegated-arin-extended-latest.txt 2>/dev/null | head -1 | cut -d'|' -f3 || echo "N/A")
        RIPENCC_SERIAL=$(grep -v '^#' delegated-ripencc-latest.txt 2>/dev/null | head -1 | cut -d'|' -f3 || echo "N/A")
        AFRINIC_SERIAL=$(grep -v '^#' delegated-afrinic-latest.txt 2>/dev/null | head -1 | cut -d'|' -f3 || echo "N/A")
        LACNIC_SERIAL=$(grep -v '^#' delegated-lacnic-latest.txt 2>/dev/null | head -1 | cut -d'|' -f3 || echo "N/A")

        # Get current UTC time for commit title
        UTC_TIME=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

        # Create commit message with RIR statistics info
        {
          echo "message<<COMMIT_MESSAGE_EOF"
          echo "${UTC_TIME}"
          echo ""
          echo "RIR statistics serial numbers:"
          echo "- APNIC: ${APNIC_SERIAL}"
          echo "- ARIN: ${ARIN_SERIAL}"
          echo "- RIPE NCC: ${RIPENCC_SERIAL}"
          echo "- AFRINIC: ${AFRINIC_SERIAL}"
          echo "- LACNIC: ${LACNIC_SERIAL}"
          echo "COMMIT_MESSAGE_EOF"
        } >> "$GITHUB_OUTPUT"
    - name: Generate sha256sums.txt
      run: sha256sum -b *.txt > sha256sums.txt
    - name: Check Git version for git-last-modified support
      run: |
        GIT_VERSION=$(git --version | awk '{print $3}')
        REQUIRED_VERSION="2.52"
        
        # Compare versions (returns true if GIT_VERSION >= REQUIRED_VERSION)
        if printf '%s\n%s\n' "$REQUIRED_VERSION" "$GIT_VERSION" | sort -V -C; then
          echo "Git version $GIT_VERSION meets the minimum requirement ($REQUIRED_VERSION)"
        else
          echo "Error: Git version $GIT_VERSION is below the minimum required version $REQUIRED_VERSION"
          echo "The git-last-modified command requires Git 2.52 or higher"
          exit 1
        fi
    - name: Restore last git modified time
      run: |
        # Use git last-modified to get the commit that last modified each file
        # Then touch each file with the commit's author date
        git last-modified -r | while IFS=$'\t' read -r commit_sha filepath; do
          if [ -f "$filepath" ]; then
            # Get the author date of the commit in a format suitable for touch
            commit_date=$(git show -s --format='%ai' "$commit_sha")
            touch -d "$commit_date" "$filepath"
          fi
        done
    - name: Generate index.html
      run: |
        tree -I 'CNAME' -H '.' -L 1 -h -D --timefmt '%Y-%m-%d %H:%M:%S %Z' --noreport --charset utf-8 -T 'Country IP Blocks' -o index.html
        sed -i "/\".\"/d" index.html
        cat github-corner.html >> index.html
        sed -i "s/your-url/github.com\/${GH_USER}\/${REPO}/g" index.html
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: ${{ steps.commit_message.outputs.message }}
